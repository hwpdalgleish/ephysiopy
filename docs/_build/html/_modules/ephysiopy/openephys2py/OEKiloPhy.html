

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ephysiopy.openephys2py.OEKiloPhy &mdash; ephysiopy 1.5.55 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> ephysiopy
          

          
          </a>

          
            
            
              <div class="version">
                1.5
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ephysiopy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>ephysiopy.openephys2py.OEKiloPhy</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ephysiopy.openephys2py.OEKiloPhy</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The main interface for dealing with openephys data recorded in</span>
<span class="sd">either the .nwb or binary format (ie when using neuropixels)</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="k">try</span><span class="p">:</span>
	<span class="kn">import</span> <span class="nn">xml.etree.cElementTree</span> <span class="k">as</span> <span class="nn">ET</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
	<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="k">try</span><span class="p">:</span>
	<span class="kn">from</span> <span class="nn">.ephysiopy.openephys2py.OESettings</span> <span class="kn">import</span> <span class="n">Settings</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
	<span class="kn">from</span> <span class="nn">ephysiopy.openephys2py.OESettings</span> <span class="kn">import</span> <span class="n">Settings</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="sd">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="KiloSortSession"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.KiloSortSession">[docs]</a><span class="k">class</span> <span class="nc">KiloSortSession</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Loads and processes data from a Kilosort session.</span>

<span class="sd">	The results of a kilosort session are a load of .npy files, a .csv or .tsv file.</span>
<span class="sd">	The .npy files contain things like spike times, cluster indices and so on.</span>
<span class="sd">	Importantly	the .csv (or .tsv) file contains the cluster identities of</span>
<span class="sd">	the SAVED part of the phy template-gui (ie when you click &quot;Save&quot; from the</span>
<span class="sd">	Clustering menu): this file consists of a header (&#39;cluster_id&#39; and &#39;group&#39;)</span>
<span class="sd">	where &#39;cluster_id&#39; is obvious (and relates to the identity in spk_clusters.npy),</span>
<span class="sd">	the &#39;group&#39; is a string that contains things like &#39;noise&#39; or &#39;unsorted&#39; or</span>
<span class="sd">	whatever as the phy user can define their own labels.</span>

<span class="sd">	Parameters</span>
<span class="sd">	----------</span>
<span class="sd">	fname_root : str</span>
<span class="sd">		The top-level directory. If the Kilosort session was run directly on data</span>
<span class="sd">		from an openephys recording session then fname_root is typically in form</span>
<span class="sd">		of YYYY-MM-DD_HH-MM-SS</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_root</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Walk through the path to find the location of the files in case this has been</span>
<span class="sd">		called in another way i.e. binary format a la Neuropixels</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fname_root</span> <span class="o">=</span> <span class="n">fname_root</span>
		<span class="kn">import</span> <span class="nn">os</span>
		<span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">fname_root</span><span class="p">):</span>
			<span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
				<span class="k">if</span> <span class="s1">&#39;spike_times.npy&#39;</span> <span class="ow">in</span> <span class="n">ff</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">fname_root</span> <span class="o">=</span> <span class="n">d</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cluster_id</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">spk_clusters</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">spk_times</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="KiloSortSession.load"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.KiloSortSession.load">[docs]</a>	<span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Load all the relevant files</span>

<span class="sd">		Notes</span>
<span class="sd">		-----</span>
<span class="sd">		* The file cluster_KSLabel.tsv is output from KiloSort and so algorithm defined</span>
<span class="sd">			as opposed to...</span>
<span class="sd">		* cluster_group.tsv or cluster_groups.csv which are group labels from phy and</span>
<span class="sd">			so user defined (has labels like &#39;good&#39;, &#39;MUA&#39;, &#39;noise&#39; etc)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="kn">import</span> <span class="nn">os</span>
		<span class="n">dtype</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;cluster_id&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">),</span> <span class="s1">&#39;formats&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;S10&#39;</span><span class="p">)}</span>
		<span class="c1"># One of these (cluster_groups.csv or cluster_group.tsv) is from kilosort and the other from kilosort2</span>
		<span class="c1"># and is updated by the user when doing cluster assignment in phy (or whatever)</span>
		<span class="c1"># See comments above this class definition for a bit more info</span>
		<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname_root</span><span class="p">,</span> <span class="s1">&#39;cluster_groups.csv&#39;</span><span class="p">)):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">cluster_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname_root</span><span class="p">,</span> <span class="s1">&#39;cluster_groups.csv&#39;</span><span class="p">),</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname_root</span><span class="p">,</span> <span class="s1">&#39;cluster_group.tsv&#39;</span><span class="p">)):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">cluster_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname_root</span><span class="p">,</span> <span class="s1">&#39;cluster_group.tsv&#39;</span><span class="p">),</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Output some information to the user if self.cluster_id is still None</span>
<span class="sd">		it implies that data has not been sorted / curated</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="kn">import</span> <span class="nn">warnings</span>
			<span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No cluster_groups.tsv or cluster_group.csv file was found. Have you run phy?&quot;</span><span class="p">)</span>
		
		<span class="n">dtype</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;cluster_id&#39;</span><span class="p">,</span> <span class="s1">&#39;KSLabel&#39;</span><span class="p">),</span> <span class="s1">&#39;formats&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;S10&#39;</span><span class="p">)}</span>
		<span class="c1"># &#39;Raw&#39; labels from a kilosort session</span>
		<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname_root</span><span class="p">,</span> <span class="s1">&#39;cluster_KSLabel.tsv&#39;</span><span class="p">)):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ks_cluster_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ks_group</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname_root</span><span class="p">,</span> <span class="s1">&#39;cluster_KSLabel.tsv&#39;</span><span class="p">),</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">spk_clusters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname_root</span><span class="p">,</span> <span class="s1">&#39;spike_clusters.npy&#39;</span><span class="p">)))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">spk_times</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname_root</span><span class="p">,</span> <span class="s1">&#39;spike_times.npy&#39;</span><span class="p">)))</span></div>

<div class="viewcode-block" id="KiloSortSession.removeNoiseClusters"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.KiloSortSession.removeNoiseClusters">[docs]</a>	<span class="k">def</span> <span class="nf">removeNoiseClusters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Removes clusters with labels &#39;noise&#39; and &#39;mua&#39; in self.group</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">good_clusters</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">for</span> <span class="n">id_group</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">):</span>
				<span class="k">if</span> <span class="s1">&#39;noise&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">id_group</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;mua&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">id_group</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">():</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">good_clusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">id_group</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="OpenEphysBase"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysBase">[docs]</a><span class="k">class</span> <span class="nc">OpenEphysBase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Base class for openephys anaylsis with data recorded in either the NWB or binary format</span>

<span class="sd">	Parameters</span>
<span class="sd">	----------</span>
<span class="sd">	pname_root : str</span>
<span class="sd">		The top-level directory, typically in form of YYYY-MM-DD_HH-MM-SS</span>

<span class="sd">	Notes</span>
<span class="sd">	----</span>
<span class="sd">	This isn&#39;t really an Abstract Base Class (as with c++) as Python doesn&#39;t really have this</span>
<span class="sd">	concept but it forms the backbone for two other classes (OpenEphysNPX &amp; OpenEphysNWB)</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pname_root</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">pname_root</span> <span class="o">=</span> <span class="n">pname_root</span> <span class="c1"># top-level directory, typically of form YYYY-MM-DD_HH-MM-SS</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">kilodata</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">rawData</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">xy</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">xyTS</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">recording_start_time</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ts</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ttl_data</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ttl_timestamps</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">spikeData</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># a list of np.arrays, nominally containing tetrode data in format nspikes x 4 x 40</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">accelerometerData</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># np.array</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># OESettings.Settings instance</span>
		<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;jumpmax&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">jumpmax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;jumpmax&#39;</span><span class="p">]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">jumpmax</span> <span class="o">=</span> <span class="mi">100</span>

<div class="viewcode-block" id="OpenEphysBase.load"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysBase.load">[docs]</a>	<span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="c1"># Overridden by sub-classes</span>
		<span class="k">pass</span></div>

<div class="viewcode-block" id="OpenEphysBase.loadKilo"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysBase.loadKilo">[docs]</a>	<span class="k">def</span> <span class="nf">loadKilo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="c1"># Loads a kilosort session</span>
		<span class="n">kilodata</span> <span class="o">=</span> <span class="n">KiloSortSession</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pname_root</span><span class="p">)</span> <span class="c1"># pname_root gets walked through and over-written with correct location of kiolsort data</span>
		<span class="n">kilodata</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
		<span class="n">kilodata</span><span class="o">.</span><span class="n">removeNoiseClusters</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">kilodata</span> <span class="o">=</span> <span class="n">kilodata</span></div>

	<span class="k">def</span> <span class="nf">__loadSettings__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="c1"># Loads the settings.xml data</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="kn">import</span> <span class="nn">os</span>
			<span class="n">settings</span> <span class="o">=</span> <span class="n">Settings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pname_root</span><span class="p">)</span> <span class="c1"># pname_root gets walked through and over-written with correct location of settings.xml</span>
			<span class="n">settings</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
			<span class="n">settings</span><span class="o">.</span><span class="n">parsePos</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">settings</span>

	<span class="k">def</span> <span class="nf">__loaddata__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pname_root</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="c1"># some knarly hack</span>

<div class="viewcode-block" id="OpenEphysBase.plotXCorrs"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysBase.plotXCorrs">[docs]</a>	<span class="k">def</span> <span class="nf">plotXCorrs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kilodata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">loadKilo</span><span class="p">()</span>
		<span class="kn">from</span> <span class="nn">ephysiopy.ephys_generic.ephys_generic</span> <span class="kn">import</span> <span class="n">SpikeCalcsGeneric</span>
		<span class="n">corriter</span> <span class="o">=</span> <span class="n">SpikeCalcsGeneric</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kilodata</span><span class="o">.</span><span class="n">spk_times</span><span class="p">)</span>
		<span class="n">corriter</span><span class="o">.</span><span class="n">spk_clusters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kilodata</span><span class="o">.</span><span class="n">spk_clusters</span>
		<span class="n">corriter</span><span class="o">.</span><span class="n">plotAllXCorrs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kilodata</span><span class="o">.</span><span class="n">good_clusters</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenEphysBase.plotPos"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysBase.plotPos">[docs]</a>	<span class="k">def</span> <span class="nf">plotPos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jumpmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Plots x vs y position for the current trial</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		jumpmax : int</span>
<span class="sd">			The max amount the LED is allowed to instantaneously move</span>
<span class="sd">		show : bool</span>
<span class="sd">			Whether to plot the pos into a figure window or not (default True)</span>

<span class="sd">		Returns</span>
<span class="sd">		----------</span>
<span class="sd">		xy : array_like</span>
<span class="sd">			positional data following post-processing</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">jumpmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">jumpmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jumpmax</span>
		<span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="k">as</span> <span class="nn">plt</span>
		<span class="kn">from</span> <span class="nn">ephysiopy.ephys_generic.ephys_generic</span> <span class="kn">import</span> <span class="n">PosCalcsGeneric</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">__loadSettings__</span><span class="p">()</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">__loaddata__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
		<span class="n">posProcessor</span> <span class="o">=</span> <span class="n">PosCalcsGeneric</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">ppm</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">cm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">jumpmax</span><span class="o">=</span><span class="n">jumpmax</span><span class="p">)</span>
		<span class="n">xy</span><span class="p">,</span> <span class="n">hdir</span> <span class="o">=</span> <span class="n">posProcessor</span><span class="o">.</span><span class="n">postprocesspos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">tracker_params</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">hdir</span> <span class="o">=</span> <span class="n">hdir</span>
		<span class="k">if</span> <span class="n">show</span><span class="p">:</span>
			<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
			<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
			<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">xy</span></div>

<div class="viewcode-block" id="OpenEphysBase.plotMaps"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysBase.plotMaps">[docs]</a>	<span class="k">def</span> <span class="nf">plotMaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Parameters</span>
<span class="sd">		------------</span>
<span class="sd">		plot_type : str or list</span>
<span class="sd">			The type of map to plot. Valid strings include:</span>
<span class="sd">			* &#39;map&#39; - just ratemap plotted</span>
<span class="sd">			* &#39;path&#39; - just spikes on path</span>
<span class="sd">			* &#39;both&#39; - both of the above</span>
<span class="sd">			* &#39;all&#39; - both spikes on path, ratemap &amp; SAC plotted</span>
<span class="sd">		Valid kwargs: &#39;ppm&#39; - this is an integer denoting pixels per metre:</span>
<span class="sd">												lower values = more bins in ratemap / SAC</span>
<span class="sd">				&#39;cluster&#39; - int or list of ints describing which clusters to plot</span>
<span class="sd">		</span>
<span class="sd">		Notes</span>
<span class="sd">		-----</span>
<span class="sd">		If providing a specific cluster or  list of clusters to this method with the keyword </span>
<span class="sd">		&#39;cluster&#39; then this is compared against the list of clusters from the Kilosort session.</span>
<span class="sd">		Only clusters that are in both lists will be plotted.</span>

<span class="sd">		Examples</span>
<span class="sd">		--------</span>
<span class="sd">		&gt;&gt;&gt; from ephysiopy.openephys2py.OEKiloPhy import OpenEphysNPX</span>
<span class="sd">		&gt;&gt;&gt; npx = OpenEphysNPX(&#39;/path/to/data&#39;)</span>
<span class="sd">		&gt;&gt;&gt; npx.load()</span>
<span class="sd">		&gt;&gt;&gt; npx.plotMaps(plot_type=&#39;path&#39;, clusters=[1, 4, 6, 16, 22])</span>

<span class="sd">		Will plot the spikes from clusters 1, 4, 6, 16, and 22 overlaid onto the xy position data </span>
<span class="sd">		in one figure window</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kilodata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">loadKilo</span><span class="p">()</span>
		<span class="k">if</span> <span class="p">(</span> <span class="s1">&#39;ppm&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">):</span>
			<span class="n">ppm</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ppm&#39;</span><span class="p">]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">ppm</span> <span class="o">=</span> <span class="mi">400</span>
		<span class="kn">from</span> <span class="nn">ephysiopy.ephys_generic.ephys_generic</span> <span class="kn">import</span> <span class="n">PosCalcsGeneric</span><span class="p">,</span> <span class="n">MapCalcsGeneric</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">__loaddata__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
		<span class="n">posProcessor</span> <span class="o">=</span> <span class="n">PosCalcsGeneric</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">ppm</span><span class="p">,</span> <span class="n">jumpmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jumpmax</span><span class="p">)</span>
		<span class="kn">import</span> <span class="nn">os</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__loadSettings__</span><span class="p">()</span>
		<span class="n">xy</span><span class="p">,</span> <span class="n">hdir</span> <span class="o">=</span> <span class="n">posProcessor</span><span class="o">.</span><span class="n">postprocesspos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">tracker_params</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">hdir</span> <span class="o">=</span> <span class="n">hdir</span>
		<span class="n">spk_times</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kilodata</span><span class="o">.</span><span class="n">spk_times</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="mf">3e4</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">recording_start_time</span>
		<span class="n">mapiter</span> <span class="o">=</span> <span class="n">MapCalcsGeneric</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">hdir</span><span class="p">),</span> <span class="n">posProcessor</span><span class="o">.</span><span class="n">speed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyTS</span><span class="p">,</span> <span class="n">spk_times</span><span class="p">,</span> <span class="n">plot_type</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
		<span class="k">if</span> <span class="s1">&#39;cluster&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
				<span class="n">mapiter</span><span class="o">.</span><span class="n">good_clusters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">([</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">kilodata</span><span class="o">.</span><span class="n">good_clusters</span><span class="p">)</span>

			<span class="k">else</span><span class="p">:</span>
				<span class="n">mapiter</span><span class="o">.</span><span class="n">good_clusters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">kilodata</span><span class="o">.</span><span class="n">good_clusters</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">mapiter</span><span class="o">.</span><span class="n">good_clusters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kilodata</span><span class="o">.</span><span class="n">good_clusters</span>
		<span class="n">mapiter</span><span class="o">.</span><span class="n">spk_clusters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kilodata</span><span class="o">.</span><span class="n">spk_clusters</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">mapiter</span> <span class="o">=</span> <span class="n">mapiter</span>
		<span class="n">mapiter</span><span class="o">.</span><span class="n">plotAll</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpenEphysBase.plotMapsOneAtATime"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysBase.plotMapsOneAtATime">[docs]</a>	<span class="k">def</span> <span class="nf">plotMapsOneAtATime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		plot_type : str or list</span>
<span class="sd">			The kind of plot to produce</span>
<span class="sd">			 Valid strings include:</span>
<span class="sd">			* &#39;map&#39; - just ratemap plotted</span>
<span class="sd">			* &#39;path&#39; - just spikes on path</span>
<span class="sd">			* &#39;both&#39; - both of the above</span>
<span class="sd">			* &#39;all&#39; - both spikes on path, ratemap &amp; SAC plotted</span>
<span class="sd">		</span>
<span class="sd">		Notes</span>
<span class="sd">		-----</span>
<span class="sd">		Valid keyword arguments include:</span>
<span class="sd">		* &#39;ppm&#39; - this is an integer denoting pixels per metre where </span>
<span class="sd">			lower values = more bins in ratemap / SAC</span>
<span class="sd">		* &#39;clusters&#39; - int or list of ints describing which clusters to plot</span>
<span class="sd">			i.e. this overwrites the &#39;good_clusters&#39; value in self.kilodata</span>
<span class="sd">		* &#39;save_grid_summary_location&#39; - bool; if present the dictionary returned from</span>
<span class="sd">			gridcell.SAC.getMeasures is saved for each cluster - this is passed to MapCalcsGeneric</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kilodata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">loadKilo</span><span class="p">()</span>
		<span class="k">if</span> <span class="p">(</span> <span class="s1">&#39;ppm&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">):</span>
			<span class="n">ppm</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ppm&#39;</span><span class="p">]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">ppm</span> <span class="o">=</span> <span class="mi">400</span>
		<span class="kn">from</span> <span class="nn">ephysiopy.ephys_generic.ephys_generic</span> <span class="kn">import</span> <span class="n">PosCalcsGeneric</span><span class="p">,</span> <span class="n">MapCalcsGeneric</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">__loaddata__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
		<span class="n">posProcessor</span> <span class="o">=</span> <span class="n">PosCalcsGeneric</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">ppm</span><span class="p">,</span> <span class="n">jumpmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jumpmax</span><span class="p">)</span>
		<span class="kn">import</span> <span class="nn">os</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__loadSettings__</span><span class="p">()</span>
		<span class="n">xy</span><span class="p">,</span> <span class="n">hdir</span> <span class="o">=</span> <span class="n">posProcessor</span><span class="o">.</span><span class="n">postprocesspos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">tracker_params</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">hdir</span> <span class="o">=</span> <span class="n">hdir</span>
		<span class="n">spk_times</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kilodata</span><span class="o">.</span><span class="n">spk_times</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="mf">3e4</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">recording_start_time</span>
		<span class="n">mapiter</span> <span class="o">=</span> <span class="n">MapCalcsGeneric</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">hdir</span><span class="p">),</span> <span class="n">posProcessor</span><span class="o">.</span><span class="n">speed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyTS</span><span class="p">,</span> <span class="n">spk_times</span><span class="p">,</span> <span class="n">plot_type</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
		<span class="k">if</span> <span class="s1">&#39;clusters&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;clusters&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
				<span class="n">mapiter</span><span class="o">.</span><span class="n">good_clusters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">([</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;clusters&#39;</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">kilodata</span><span class="o">.</span><span class="n">good_clusters</span><span class="p">)</span>

			<span class="k">else</span><span class="p">:</span>
				<span class="n">mapiter</span><span class="o">.</span><span class="n">good_clusters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;clusters&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">kilodata</span><span class="o">.</span><span class="n">good_clusters</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">mapiter</span><span class="o">.</span><span class="n">good_clusters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kilodata</span><span class="o">.</span><span class="n">good_clusters</span>
		<span class="n">mapiter</span><span class="o">.</span><span class="n">spk_clusters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kilodata</span><span class="o">.</span><span class="n">spk_clusters</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">mapiter</span> <span class="o">=</span> <span class="n">mapiter</span>
		<span class="c1"># mapiter.plotAll()</span>
		<span class="p">[</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">mapiter</span> <span class="p">]</span></div>

<div class="viewcode-block" id="OpenEphysBase.plotEEGPower"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysBase.plotEEGPower">[docs]</a>	<span class="k">def</span> <span class="nf">plotEEGPower</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Plots LFP power</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		channel : int</span>
<span class="sd">			The channel from which to plot the power</span>

<span class="sd">		See Also</span>
<span class="sd">		-----</span>
<span class="sd">		EEGCalcsGeneric.plotPowerSpectrum</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="kn">from</span> <span class="nn">ephysiopy.ephys_generic.ephys_generic</span> <span class="kn">import</span> <span class="n">EEGCalcsGeneric</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawData</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading raw data...&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">loadraw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span>
		<span class="n">n_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rawData</span><span class="p">[:,</span><span class="n">channel</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rawData</span><span class="p">[:,</span><span class="n">channel</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_samples</span><span class="o">/</span><span class="mf">3e4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">500</span><span class="p">)</span>
		<span class="n">E</span> <span class="o">=</span> <span class="n">EEGCalcsGeneric</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
		<span class="n">E</span><span class="o">.</span><span class="n">plotPowerSpectrum</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpenEphysBase.plotSpectrogram"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysBase.plotSpectrogram">[docs]</a>	<span class="k">def</span> <span class="nf">plotSpectrogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nSeconds</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">secsPerBin</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">250</span><span class="p">):</span>
		<span class="kn">from</span> <span class="nn">ephysiopy.ephys_generic.ephys_generic</span> <span class="kn">import</span> <span class="n">EEGCalcsGeneric</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawData</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading raw data...&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">loadraw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="c1"># load first 30 seconds by default</span>
		<span class="n">fs</span> <span class="o">=</span> <span class="mf">3e4</span>
		<span class="n">E</span> <span class="o">=</span> <span class="n">EEGCalcsGeneric</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rawData</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="mf">3e4</span><span class="o">*</span><span class="n">nSeconds</span><span class="p">),</span><span class="mi">0</span><span class="p">],</span> <span class="n">fs</span><span class="p">)</span>
		<span class="n">nperseg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fs</span> <span class="o">*</span> <span class="n">secsPerBin</span><span class="p">)</span>
		<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span>
		<span class="n">freqs</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">Sxx</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">spectrogram</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">sig</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">nperseg</span><span class="o">=</span><span class="n">nperseg</span><span class="p">)</span>
		<span class="n">Sxx_sm</span> <span class="o">=</span> <span class="n">Sxx</span>
		<span class="kn">from</span> <span class="nn">ephysiopy.ephys_generic</span> <span class="kn">import</span> <span class="n">binning</span>
		<span class="n">R</span> <span class="o">=</span> <span class="n">binning</span><span class="o">.</span><span class="n">RateMap</span><span class="p">()</span>
		<span class="n">Sxx_sm</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">blurImage</span><span class="p">(</span><span class="n">Sxx</span><span class="p">,</span> <span class="p">(</span><span class="n">secsPerBin</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">freqs</span><span class="p">)</span>
		<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">colors</span>
		<span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
			<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
			<span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">Sxx_sm</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;face&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">())</span>
		<span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">Sxx_sm</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;face&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">())</span>
		<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
		<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span>
		<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time(s)&#39;</span><span class="p">)</span>
		<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency(Hz)&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenEphysBase.plotPSTH"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysBase.plotPSTH">[docs]</a>	<span class="k">def</span> <span class="nf">plotPSTH</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="kn">import</span> <span class="nn">os</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__loadSettings__</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">parseStimControl</span><span class="p">()</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kilodata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">loadKilo</span><span class="p">()</span>
		<span class="kn">from</span> <span class="nn">ephysiopy.ephys_generic.ephys_generic</span> <span class="kn">import</span> <span class="n">SpikeCalcsGeneric</span>
		<span class="n">spk_times</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kilodata</span><span class="o">.</span><span class="n">spk_times</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">3e4</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># in seconds</span>
		<span class="n">S</span> <span class="o">=</span> <span class="n">SpikeCalcsGeneric</span><span class="p">(</span><span class="n">spk_times</span><span class="p">)</span>
		<span class="n">S</span><span class="o">.</span><span class="n">event_ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttl_timestamps</span><span class="p">[</span><span class="mi">2</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># this is because some of the trials have two weird events logged at about 2-3 minutes in...</span>
		<span class="n">S</span><span class="o">.</span><span class="n">spk_clusters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kilodata</span><span class="o">.</span><span class="n">spk_clusters</span>
		<span class="n">S</span><span class="o">.</span><span class="n">stim_width</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="c1"># in seconds</span>
		<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kilodata</span><span class="o">.</span><span class="n">good_clusters</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">plotPSTH</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span></div>

<div class="viewcode-block" id="OpenEphysBase.plotEventEEG"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysBase.plotEventEEG">[docs]</a>	<span class="k">def</span> <span class="nf">plotEventEEG</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="kn">from</span> <span class="nn">ephysiopy.ephys_generic.ephys_generic</span> <span class="kn">import</span> <span class="n">EEGCalcsGeneric</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawData</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading raw data...&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">loadraw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="n">E</span> <span class="o">=</span> <span class="n">EEGCalcsGeneric</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rawData</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="mf">3e4</span><span class="p">)</span>
		<span class="n">event_ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttl_timestamps</span><span class="p">[</span><span class="mi">2</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># this is because some of the trials have two weird events logged at about 2-3 minutes in...</span>
		<span class="n">E</span><span class="o">.</span><span class="n">plotEventEEG</span><span class="p">(</span><span class="n">event_ts</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenEphysBase.plotWaves"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysBase.plotWaves">[docs]</a>	<span class="k">def</span> <span class="nf">plotWaves</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kilodata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">loadKilo</span><span class="p">()</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawData</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading raw data...&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">loadraw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="c1"># Find the amplitudes.npy file</span>
		<span class="kn">import</span> <span class="nn">os</span>
		<span class="n">amplitudes</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pname_root</span><span class="p">):</span>
			<span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
				<span class="k">if</span> <span class="s1">&#39;amplitudes.npy&#39;</span> <span class="ow">in</span> <span class="n">ff</span><span class="p">:</span>
					<span class="n">amplitudes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s1">&#39;amplitudes.npy&#39;</span><span class="p">))</span>
		<span class="k">if</span> <span class="n">amplitudes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="kn">import</span> <span class="nn">warnings</span>
			<span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No amplitudes.npy file was found so cant plot waveforms. Have you run Kilosort?&quot;</span><span class="p">)</span>
			<span class="k">return</span>
		<span class="n">waveiter</span> <span class="o">=</span> <span class="n">SpkWaveform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kilodata</span><span class="o">.</span><span class="n">good_clusters</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kilodata</span><span class="o">.</span><span class="n">spk_times</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kilodata</span><span class="o">.</span><span class="n">spk_clusters</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawData</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">waveiter</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cluster </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cluster</span><span class="p">))</span></div></div>

<div class="viewcode-block" id="OpenEphysNPX"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysNPX">[docs]</a><span class="k">class</span> <span class="nc">OpenEphysNPX</span><span class="p">(</span><span class="n">OpenEphysBase</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;docstring for OpenEphysNPX&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pname_root</span><span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">pname_root</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">path2PosData</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">path2APdata</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">path2LFPdata</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="OpenEphysNPX.load"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysNPX.load">[docs]</a>	<span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pname_root</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">experiment_name</span><span class="o">=</span><span class="s1">&#39;experiment1&#39;</span><span class="p">,</span> <span class="n">recording_name</span><span class="o">=</span><span class="s1">&#39;recording1&#39;</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		Loads data recorded in the OE &#39;flat&#39; binary format</span>
<span class="sd">		See https://open-ephys.atlassian.net/wiki/spaces/OEW/pages/166789121/Flat+binary+format for more</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		pname_root - str - the top level directory, typically in form of YYYY-MM-DD_HH-MM-SS</span>

<span class="sd">		recording_name - str - pretty obvious but this is also the directory immediately beneath pname_root</span>
<span class="sd">		&#39;&#39;&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">isBinary</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="kn">import</span> <span class="nn">os</span>
		<span class="kn">import</span> <span class="nn">re</span>
		<span class="n">APdata_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;Neuropix-PXI-[0-9][0-9][0-9].0&#39;</span><span class="p">)</span>
		<span class="n">LFPdata_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;Neuropix-PXI-[0-9][0-9][0-9].1&#39;</span><span class="p">)</span>
		<span class="n">sync_message_file</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">recording_start_time</span> <span class="o">=</span> <span class="kc">None</span>

		<span class="k">if</span> <span class="n">pname_root</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">pname_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pname_root</span>

		<span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">pname_root</span><span class="p">):</span>
			<span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
				<span class="k">if</span> <span class="s1">&#39;data_array.npy&#39;</span> <span class="ow">in</span> <span class="n">ff</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">path2PosData</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
				<span class="k">if</span> <span class="s1">&#39;continuous.dat&#39;</span> <span class="ow">in</span> <span class="n">ff</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">APdata_match</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">path2APdata</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">LFPdata_match</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">path2LFPdata</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
				<span class="k">if</span> <span class="s1">&#39;sync_messages.txt&#39;</span> <span class="ow">in</span> <span class="n">ff</span><span class="p">:</span>
					<span class="n">sync_message_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s1">&#39;sync_messages.txt&#39;</span><span class="p">)</span>

		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path2PosData</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">pos_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path2PosData</span><span class="p">,</span> <span class="s1">&#39;data_array.npy&#39;</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">xy</span> <span class="o">=</span> <span class="n">pos_data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
			<span class="n">pos_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path2PosData</span><span class="p">,</span> <span class="s1">&#39;timestamps.npy&#39;</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">xyTS</span> <span class="o">=</span> <span class="n">pos_ts</span> <span class="o">/</span> <span class="mf">30.0</span> <span class="o">/</span> <span class="mf">1000.0</span>

		<span class="n">ap_sample_rate</span> <span class="o">=</span> <span class="mi">30000</span>
		<span class="n">n_channels</span> <span class="o">=</span> <span class="mi">384</span>
		<span class="n">trial_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__calcTrialLengthFromBinarySize__</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path2APdata</span><span class="p">,</span> <span class="s1">&#39;continuous.dat&#39;</span><span class="p">),</span> <span class="n">n_channels</span><span class="p">,</span> <span class="n">ap_sample_rate</span><span class="p">)</span>
		<span class="c1"># Load the start time from the sync_messages file</span>
		<span class="k">if</span> <span class="n">sync_message_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sync_message_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
				<span class="n">sync_strs</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
			<span class="n">sync_lines</span> <span class="o">=</span> <span class="n">sync_strs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">sync_lines</span><span class="p">:</span>
				<span class="k">if</span> <span class="s1">&#39;subProcessor: 0&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
					<span class="n">idx</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;start time: &#39;</span><span class="p">)</span>
					<span class="n">start_val</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="s1">&#39;start time: &#39;</span><span class="p">):</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
					<span class="n">tmp</span> <span class="o">=</span> <span class="n">start_val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)</span>
					<span class="n">recording_start_time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">recording_start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyTS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">recording_start_time</span> <span class="o">=</span> <span class="n">recording_start_time</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">recording_start_time</span><span class="p">,</span> <span class="n">trial_length</span><span class="o">+</span><span class="n">recording_start_time</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">ap_sample_rate</span><span class="p">)</span></div>

	<span class="k">def</span> <span class="nf">__calcTrialLengthFromBinarySize__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path2file</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">n_channels</span><span class="o">=</span><span class="mi">384</span><span class="p">,</span> <span class="n">sample_rate</span><span class="o">=</span><span class="mi">30000</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns the time taken to run the trial (in seconds) based on the size of</span>
<span class="sd">		the binary file on disk</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="kn">import</span> <span class="nn">os</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path2file</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="o">.</span><span class="n">st_size</span> <span class="o">/</span> <span class="p">(</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">n_channels</span> <span class="o">*</span> <span class="n">sample_rate</span><span class="p">)</span>

<div class="viewcode-block" id="OpenEphysNPX.plotSpectrogramByDepth"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysNPX.plotSpectrogramByDepth">[docs]</a>	<span class="k">def</span> <span class="nf">plotSpectrogramByDepth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nchannels</span><span class="o">=</span><span class="mi">384</span><span class="p">,</span> <span class="n">nseconds</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">maxFreq</span><span class="o">=</span><span class="mi">125</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Plots a heat map spectrogram of the LFP for each channel.</span>

<span class="sd">		Line plots of power per frequency band and power on a subset of channels are </span>
<span class="sd">		also displayed to the right and above the main plot.</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		nchannels : int</span>
<span class="sd">			The number of channels on the probe</span>
<span class="sd">		nseconds : int, optional</span>
<span class="sd">			How long in seconds from the start of the trial to do the spectrogram for (for speed).</span>
<span class="sd">			Default 100</span>
<span class="sd">		maxFreq : int</span>
<span class="sd">			The maximum frequency in Hz to plot the spectrogram out to. Maximum 1250.</span>
<span class="sd">			Default 125</span>
<span class="sd">		</span>
<span class="sd">		Notes</span>
<span class="sd">		-----</span>
<span class="sd">		Should also allow kwargs to specify exactly which channels and / or frequency</span>
<span class="sd">		bands to do the line plots for</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="kn">import</span> <span class="nn">os</span>
		<span class="n">lfp_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path2LFPdata</span><span class="p">,</span> <span class="s1">&#39;continuous.dat&#39;</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">lfp_file</span><span class="p">)</span>
		<span class="n">nsamples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">st_size</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">nchannels</span><span class="p">)</span>
		<span class="n">mmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="n">lfp_file</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">nchannels</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
		<span class="c1"># Load the channel map NB assumes this is in the AP data location and that kilosort was run there</span>
		<span class="n">channel_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path2APdata</span><span class="p">,</span> <span class="s1">&#39;channel_map.npy&#39;</span><span class="p">)))</span>
		<span class="n">lfp_sample_rate</span> <span class="o">=</span> <span class="mi">2500</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mmap</span><span class="p">[</span><span class="n">channel_map</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">nseconds</span><span class="o">*</span><span class="n">lfp_sample_rate</span><span class="p">])</span>
		<span class="kn">from</span> <span class="nn">ephysiopy.ephys_generic.ephys_generic</span> <span class="kn">import</span> <span class="n">EEGCalcsGeneric</span>
		<span class="n">E</span> <span class="o">=</span> <span class="n">EEGCalcsGeneric</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">lfp_sample_rate</span><span class="p">)</span>
		<span class="n">E</span><span class="o">.</span><span class="n">calcEEGPowerSpectrum</span><span class="p">()</span>
		<span class="n">spec_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">sm_power</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">50</span><span class="p">])))</span>
		<span class="k">for</span> <span class="n">chan</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
			<span class="n">E</span> <span class="o">=</span> <span class="n">EEGCalcsGeneric</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">chan</span><span class="p">,</span> <span class="p">:],</span> <span class="n">lfp_sample_rate</span><span class="p">)</span>
			<span class="n">E</span><span class="o">.</span><span class="n">calcEEGPowerSpectrum</span><span class="p">()</span>
			<span class="n">spec_data</span><span class="p">[</span><span class="n">chan</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">sm_power</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">50</span><span class="p">]</span>

		<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">50</span><span class="p">],</span> <span class="n">channel_map</span><span class="p">)</span>
		<span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="nn">colors</span>
		<span class="kn">from</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">import</span> <span class="n">cm</span>
		<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>
		<span class="n">_</span><span class="p">,</span> <span class="n">spectoAx</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
		<span class="n">spectoAx</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">spec_data</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;face&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bone&#39;</span><span class="p">,</span><span class="n">norm</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">())</span>
		<span class="n">spectoAx</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxFreq</span><span class="p">)</span>
		<span class="n">spectoAx</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">channel_map</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">channel_map</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
		<span class="n">spectoAx</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (Hz)&#39;</span><span class="p">)</span>
		<span class="n">spectoAx</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Channel&#39;</span><span class="p">)</span>
		<span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">spectoAx</span><span class="p">)</span>
		<span class="n">channel_spectoAx</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="n">pad</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">spectoAx</span><span class="p">)</span>
		<span class="n">meanfreq_powerAx</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="n">pad</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">spectoAx</span><span class="p">)</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">channel_spectoAx</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> <span class="o">+</span> <span class="n">meanfreq_powerAx</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

		<span class="n">mn_power</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spec_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cols</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">rainbow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,(</span><span class="n">nchannels</span><span class="o">//</span><span class="mi">60</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">spec_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">60</span><span class="p">):</span>
			<span class="n">c</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
			<span class="n">channel_spectoAx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">50</span><span class="p">],</span> <span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">spec_data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">/</span><span class="n">mn_power</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

		<span class="n">channel_spectoAx</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Channel power(dB)&#39;</span><span class="p">)</span>
		<span class="n">channel_spectoAx</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.02</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="o">.</span><span class="mi">102</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">,</span>
			<span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;x-small&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

		<span class="n">freq_inc</span> <span class="o">=</span> <span class="mi">6</span>
		<span class="n">lower_freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxFreq</span><span class="o">-</span><span class="n">freq_inc</span><span class="p">,</span> <span class="n">freq_inc</span><span class="p">)</span>
		<span class="n">upper_freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">freq_inc</span><span class="p">,</span> <span class="n">maxFreq</span><span class="p">,</span> <span class="n">freq_inc</span><span class="p">)</span>
		<span class="n">cols</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">nipy_spectral</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">upper_freqs</span><span class="p">))))</span>
		<span class="n">mn_power</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spec_data</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">freqs</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lower_freqs</span><span class="p">,</span> <span class="n">upper_freqs</span><span class="p">):</span>
			<span class="n">freq_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">50</span><span class="p">]</span><span class="o">&gt;</span><span class="n">freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">E</span><span class="o">.</span><span class="n">freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">50</span><span class="p">]</span><span class="o">&lt;</span><span class="n">freqs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
			<span class="n">mean_power</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spec_data</span><span class="p">[:,</span> <span class="n">freq_mask</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">mn_power</span><span class="p">)</span>
			<span class="n">c</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
			<span class="n">meanfreq_powerAx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mean_power</span><span class="p">,</span> <span class="n">channel_map</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
		<span class="n">meanfreq_powerAx</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Mean freq. band power(dB)&#39;</span><span class="p">)</span>
		<span class="n">meanfreq_powerAx</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.02</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="o">.</span><span class="mi">102</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">,</span>
			<span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;x-small&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpenEphysNPX.plotPos"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysNPX.plotPos">[docs]</a>	<span class="k">def</span> <span class="nf">plotPos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jumpmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">plotPos</span><span class="p">(</span><span class="n">jumpmax</span><span class="p">,</span> <span class="n">show</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenEphysNPX.plotMaps"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysNPX.plotMaps">[docs]</a>	<span class="k">def</span> <span class="nf">plotMaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">plotMaps</span><span class="p">(</span><span class="n">plot_type</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenEphysNPX.plotMapsOneAtATime"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysNPX.plotMapsOneAtATime">[docs]</a>	<span class="k">def</span> <span class="nf">plotMapsOneAtATime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">plotMapsOneAtATime</span><span class="p">(</span><span class="n">plot_type</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenEphysNPX.plotEEGPower"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysNPX.plotEEGPower">[docs]</a>	<span class="k">def</span> <span class="nf">plotEEGPower</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">plotEEGPower</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenEphysNPX.plotSpectrogram"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysNPX.plotSpectrogram">[docs]</a>	<span class="k">def</span> <span class="nf">plotSpectrogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nSeconds</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">secsPerBin</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">250</span><span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">plotSpectrogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nSeconds</span><span class="p">,</span> <span class="n">secsPerBin</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenEphysNPX.plotPSTH"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysNPX.plotPSTH">[docs]</a>	<span class="k">def</span> <span class="nf">plotPSTH</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">plotPSTH</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpenEphysNPX.plotEventEEG"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysNPX.plotEventEEG">[docs]</a>	<span class="k">def</span> <span class="nf">plotEventEEG</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">plotEventEEG</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpenEphysNPX.plotWaves"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysNPX.plotWaves">[docs]</a>	<span class="k">def</span> <span class="nf">plotWaves</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">plotWaves</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="OpenEphysNWB"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysNWB">[docs]</a><span class="k">class</span> <span class="nc">OpenEphysNWB</span><span class="p">(</span><span class="n">OpenEphysBase</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Parameters</span>
<span class="sd">	------------</span>
<span class="sd">	pname_root : str</span>
<span class="sd">		The top level directory, typically in form of YYYY-MM-DD_HH-MM-SS</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pname_root</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">pname_root</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">nwbData</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># handle to the open nwb file (HDF5 file object)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">rawData</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># np.array holding the raw, continuous recording</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">recording_name</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># the recording name inside the nwb file (&#39;recording0&#39;, &#39;recording1&#39;, etc)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">isBinary</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="OpenEphysNWB.load"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysNWB.load">[docs]</a>	<span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pname_root</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="n">session_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recording_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">loadraw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">loadspikes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">savedat</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Loads xy pos from binary part of the hdf5 file and data resulting from</span>
<span class="sd">		a Kilosort session (see KiloSortSession class above)</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		pname_root : str</span>
<span class="sd">			The top level directory, typically the one named YYYY-MM-DD_HH-MM-SS</span>
<span class="sd">			NB In the nwb format this directory contains the experiment_1.nwb and settings.xml files</span>
<span class="sd">		session_name : str</span>
<span class="sd">			Defaults to experiment_1.nwb</span>
<span class="sd">		recording_name : str</span>
<span class="sd">			Defaults to recording0</span>
<span class="sd">		loadraw : bool</span>
<span class="sd">			Defaults to False; if True will load and save the</span>
<span class="sd">			raw part of the data</span>
<span class="sd">		savedat : bool</span>
<span class="sd">			Defaults to False; if True will extract the electrode</span>
<span class="sd">			data part of the hdf file and save as &#39;experiment_1.dat&#39;</span>
<span class="sd">			NB only works if loadraw is True. Also note that this</span>
<span class="sd">			currently saves 64 channels worth of data (ie ignores</span>
<span class="sd">			the 6 accelerometer channels)</span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="kn">import</span> <span class="nn">h5py</span>
		<span class="kn">import</span> <span class="nn">os</span>
		<span class="k">if</span> <span class="n">pname_root</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">pname_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pname_root</span>
		<span class="k">if</span> <span class="n">session_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">session_name</span> <span class="o">=</span> <span class="s1">&#39;experiment_1.nwb&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">nwbData</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pname_root</span><span class="p">,</span> <span class="n">session_name</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
		<span class="c1"># Position data...</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">recording_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">recording_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">recording_name</span> <span class="o">=</span> <span class="s1">&#39;recording1&#39;</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">recording_name</span> <span class="o">=</span> <span class="n">recording_name</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwbData</span><span class="p">[</span><span class="s1">&#39;acquisition&#39;</span><span class="p">][</span><span class="s1">&#39;timeseries&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">recording_name</span><span class="p">][</span><span class="s1">&#39;events&#39;</span><span class="p">][</span><span class="s1">&#39;binary1&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">xyTS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwbData</span><span class="p">[</span><span class="s1">&#39;acquisition&#39;</span><span class="p">][</span><span class="s1">&#39;timeseries&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">recording_name</span><span class="p">][</span><span class="s1">&#39;events&#39;</span><span class="p">][</span><span class="s1">&#39;binary1&#39;</span><span class="p">][</span><span class="s1">&#39;timestamps&#39;</span><span class="p">])</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">xyTS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyTS</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">xy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
		<span class="c1"># TTL data...</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ttl_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwbData</span><span class="p">[</span><span class="s1">&#39;acquisition&#39;</span><span class="p">][</span><span class="s1">&#39;timeseries&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">recording_name</span><span class="p">][</span><span class="s1">&#39;events&#39;</span><span class="p">][</span><span class="s1">&#39;ttl1&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ttl_timestamps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwbData</span><span class="p">[</span><span class="s1">&#39;acquisition&#39;</span><span class="p">][</span><span class="s1">&#39;timeseries&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">recording_name</span><span class="p">][</span><span class="s1">&#39;events&#39;</span><span class="p">][</span><span class="s1">&#39;ttl1&#39;</span><span class="p">][</span><span class="s1">&#39;timestamps&#39;</span><span class="p">])</span>

		<span class="c1"># ...everything else</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">__loadSettings__</span><span class="p">()</span>
			<span class="n">fpgaId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">fpga_nodeId</span>
			<span class="n">fpgaNode</span> <span class="o">=</span> <span class="s1">&#39;processor&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fpgaId</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fpgaId</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwbData</span><span class="p">[</span><span class="s1">&#39;acquisition&#39;</span><span class="p">][</span><span class="s1">&#39;timeseries&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">recording_name</span><span class="p">][</span><span class="s1">&#39;continuous&#39;</span><span class="p">][</span><span class="n">fpgaNode</span><span class="p">][</span><span class="s1">&#39;timestamps&#39;</span><span class="p">])</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">loadraw</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">rawData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwbData</span><span class="p">[</span><span class="s1">&#39;acquisition&#39;</span><span class="p">][</span><span class="s1">&#39;timeseries&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">recording_name</span><span class="p">][</span><span class="s1">&#39;continuous&#39;</span><span class="p">][</span><span class="n">fpgaNode</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">parseChannels</span><span class="p">()</span> <span class="c1"># to get the neural data channels</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">accelerometerData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawData</span><span class="p">[:,</span><span class="mi">64</span><span class="p">:]</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">rawData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawData</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">64</span><span class="p">]</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">savedat</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
					<span class="n">data2save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawData</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">64</span><span class="p">]</span>
					<span class="n">data2save</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pname_root</span><span class="p">,</span> <span class="s1">&#39;experiment_1.dat&#39;</span><span class="p">))</span>
			<span class="k">if</span> <span class="n">loadspikes</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwbData</span><span class="p">[</span><span class="s1">&#39;acquisition&#39;</span><span class="p">][</span><span class="s1">&#39;timeseries&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">recording_name</span><span class="p">][</span><span class="s1">&#39;spikes&#39;</span><span class="p">]:</span>
					<span class="c1"># Create a dictionary containing keys &#39;electrode1&#39;, &#39;electrode2&#39; etc and None for values</span>
					<span class="n">electrode_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwbData</span><span class="p">[</span><span class="s1">&#39;acquisition&#39;</span><span class="p">][</span><span class="s1">&#39;timeseries&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">recording_name</span><span class="p">][</span><span class="s1">&#39;spikes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
					<span class="c1"># Each entry in the electrode dict is itself a dict containing keys &#39;timestamps&#39; and &#39;data&#39;...</span>
					<span class="k">for</span> <span class="n">i_electrode</span> <span class="ow">in</span> <span class="n">electrode_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
						<span class="n">data_and_ts_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;timestamps&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
						<span class="n">data_and_ts_dict</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwbData</span><span class="p">[</span><span class="s1">&#39;acquisition&#39;</span><span class="p">][</span><span class="s1">&#39;timeseries&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">recording_name</span><span class="p">][</span><span class="s1">&#39;spikes&#39;</span><span class="p">][</span><span class="n">i_electrode</span><span class="p">][</span><span class="s1">&#39;timestamps&#39;</span><span class="p">])</span>
						<span class="n">data_and_ts_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwbData</span><span class="p">[</span><span class="s1">&#39;acquisition&#39;</span><span class="p">][</span><span class="s1">&#39;timeseries&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">recording_name</span><span class="p">][</span><span class="s1">&#39;spikes&#39;</span><span class="p">][</span><span class="n">i_electrode</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
						<span class="n">electrode_dict</span><span class="p">[</span><span class="n">i_electrode</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_and_ts_dict</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">spikeData</span> <span class="o">=</span> <span class="n">electrode_dict</span>
		<span class="k">except</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span></div>

<div class="viewcode-block" id="OpenEphysNWB.save_ttl"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysNWB.save_ttl">[docs]</a>	<span class="k">def</span> <span class="nf">save_ttl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_fname</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Saves the ttl data to text file out_fname</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ttl_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ttl_timestamps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">):</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">ttl_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttl_timestamps</span><span class="p">])</span>
			<span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
				<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">T</span>
			<span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">out_fname</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenEphysNWB.exportPos"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysNWB.exportPos">[docs]</a>	<span class="k">def</span> <span class="nf">exportPos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">xy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotPos</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
		<span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">xy</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyTS</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]])</span>
		<span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s1">&#39;position.txt&#39;</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%3.3i</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%3.3i</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%3.3f</span><span class="s1">&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="OpenEphysNWB.plotPos"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysNWB.plotPos">[docs]</a>	<span class="k">def</span> <span class="nf">plotPos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jumpmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
		<span class="n">xy</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">plotPos</span><span class="p">(</span><span class="n">jumpmax</span><span class="p">,</span> <span class="n">show</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">xy</span></div>

<div class="viewcode-block" id="OpenEphysNWB.plotMaps"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysNWB.plotMaps">[docs]</a>	<span class="k">def</span> <span class="nf">plotMaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">plotMaps</span><span class="p">(</span><span class="n">plot_type</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenEphysNWB.plotMapsOneAtATime"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysNWB.plotMapsOneAtATime">[docs]</a>	<span class="k">def</span> <span class="nf">plotMapsOneAtATime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">plotMapsOneAtATime</span><span class="p">(</span><span class="n">plot_type</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenEphysNWB.plotEEGPower"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysNWB.plotEEGPower">[docs]</a>	<span class="k">def</span> <span class="nf">plotEEGPower</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">plotEEGPower</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenEphysNWB.plotSpectrogram"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysNWB.plotSpectrogram">[docs]</a>	<span class="k">def</span> <span class="nf">plotSpectrogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nSeconds</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">secsPerBin</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">250</span><span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">plotSpectrogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nSeconds</span><span class="p">,</span> <span class="n">secsPerBin</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenEphysNWB.plotPSTH"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysNWB.plotPSTH">[docs]</a>	<span class="k">def</span> <span class="nf">plotPSTH</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">plotPSTH</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpenEphysNWB.plotEventEEG"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysNWB.plotEventEEG">[docs]</a>	<span class="k">def</span> <span class="nf">plotEventEEG</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">plotEventEEG</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpenEphysNWB.plotWaves"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.OpenEphysNWB.plotWaves">[docs]</a>	<span class="k">def</span> <span class="nf">plotWaves</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">plotWaves</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="SpkTimeCorrelogram"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.SpkTimeCorrelogram">[docs]</a><span class="k">class</span> <span class="nc">SpkTimeCorrelogram</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">spk_times</span><span class="p">,</span> <span class="n">spk_clusters</span><span class="p">):</span>
		<span class="kn">from</span> <span class="nn">dacq2py</span> <span class="kn">import</span> <span class="n">spikecalcs</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">SpkCalcs</span> <span class="o">=</span> <span class="n">spikecalcs</span><span class="o">.</span><span class="n">SpikeCalcs</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">clusters</span> <span class="o">=</span> <span class="n">clusters</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">spk_times</span> <span class="o">=</span> <span class="n">spk_times</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">spk_clusters</span> <span class="o">=</span> <span class="n">spk_clusters</span>

<div class="viewcode-block" id="SpkTimeCorrelogram.plotAll"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.SpkTimeCorrelogram.plotAll">[docs]</a>	<span class="k">def</span> <span class="nf">plotAll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span>
		<span class="n">nrows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">)))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">):</span>
			<span class="n">cluster_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spk_clusters</span> <span class="o">==</span> <span class="n">cluster</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">cluster_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spk_times</span><span class="p">[</span><span class="n">cluster_idx</span><span class="p">])</span>
			<span class="c1"># ts into milliseconds ie OE sample rate / 1000</span>
			<span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SpkCalcs</span><span class="o">.</span><span class="n">xcorr</span><span class="p">(</span><span class="n">cluster_ts</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="mf">30.</span><span class="p">)</span>
			<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span><span class="n">nrows</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">y</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">201</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">500</span><span class="p">,</span> <span class="mi">500</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s1">&#39;stepfilled&#39;</span><span class="p">)</span>
			<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time(ms)&#39;</span><span class="p">)</span>
			<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">500</span><span class="p">,</span><span class="mi">500</span><span class="p">)</span>
			<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">((</span><span class="o">-</span><span class="mi">500</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="p">))</span>
			<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="mi">500</span><span class="p">),</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">500</span><span class="p">)))</span>
			<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
							<span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			<span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
			<span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
			<span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
			<span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
			<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
			<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

	<span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="c1"># NOTE:</span>
		<span class="c1"># Will plot clusters in self.clusters in separate figure windows</span>
		<span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">:</span>
			<span class="n">cluster_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spk_clusters</span> <span class="o">==</span> <span class="n">cluster</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">cluster_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spk_times</span><span class="p">[</span><span class="n">cluster_idx</span><span class="p">])</span>
			<span class="c1"># ts into milliseconds ie OE sample rate / 1000</span>
			<span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SpkCalcs</span><span class="o">.</span><span class="n">xcorr</span><span class="p">(</span><span class="n">cluster_ts</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="mf">30.</span><span class="p">)</span>
			<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
			<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
			<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">y</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">201</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">500</span><span class="p">,</span> <span class="mi">500</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s1">&#39;stepfilled&#39;</span><span class="p">)</span>
			<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time(ms)&#39;</span><span class="p">)</span>
			<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">500</span><span class="p">,</span><span class="mi">500</span><span class="p">)</span>
			<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">((</span><span class="o">-</span><span class="mi">500</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="p">))</span>
			<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="mi">500</span><span class="p">),</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">500</span><span class="p">)))</span>
			<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="s1">&#39;off&#39;</span><span class="p">,</span>
							<span class="n">bottom</span><span class="o">=</span><span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
			<span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
			<span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
			<span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
			<span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
			<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
			<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Cluster &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cluster</span><span class="p">))</span>
			<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
			<span class="k">yield</span> <span class="n">cluster</span></div>

<div class="viewcode-block" id="SpkWaveform"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.SpkWaveform">[docs]</a><span class="k">class</span> <span class="nc">SpkWaveform</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="sd">&#39;&#39;&#39;</span>

<span class="sd">	&#39;&#39;&#39;</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">spk_times</span><span class="p">,</span> <span class="n">spk_clusters</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">		spk_times in samples</span>
<span class="sd">		&#39;&#39;&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">clusters</span> <span class="o">=</span> <span class="n">clusters</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">spk_times</span> <span class="o">=</span> <span class="n">spk_times</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">spk_clusters</span> <span class="o">=</span> <span class="n">spk_clusters</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">amplitudes</span> <span class="o">=</span> <span class="n">amplitudes</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span> <span class="o">=</span> <span class="n">raw_data</span>

	<span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="c1"># NOTE:</span>
		<span class="c1"># Will plot in a separate figure window for each cluster in self.clusters</span>
		<span class="c1">#</span>
		<span class="c1"># get 500us pre-spike and 1000us post-spike interval</span>
		<span class="c1"># calculate outside for loop</span>
		<span class="n">pre</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="mf">3e4</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>
		<span class="n">post</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="mf">3e4</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>
		<span class="n">nsamples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
		<span class="n">nchannels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
		<span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">,</span> <span class="n">pre</span><span class="o">+</span><span class="n">post</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">3e4</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>
		<span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">times</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">nchannels</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">:</span>
			<span class="n">cluster_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spk_clusters</span> <span class="o">==</span> <span class="n">cluster</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">nspikes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_idx</span><span class="p">)</span>
			<span class="n">data_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spk_times</span><span class="p">[</span><span class="n">cluster_idx</span><span class="p">]</span>
			<span class="n">data_from_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_idx</span><span class="o">-</span><span class="n">pre</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
			<span class="n">data_to_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_idx</span><span class="o">+</span><span class="n">post</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
			<span class="n">raw_waves</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nspikes</span><span class="p">,</span> <span class="n">pre</span><span class="o">+</span><span class="n">post</span><span class="p">,</span> <span class="n">nchannels</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>

			<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">data_from_idx</span><span class="p">,</span> <span class="n">data_to_idx</span><span class="p">)):</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
					<span class="n">raw_waves</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],:]</span>
				<span class="k">elif</span> <span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">nsamples</span><span class="p">):</span>
					<span class="n">raw_waves</span><span class="p">[</span><span class="n">i</span><span class="p">,(</span><span class="n">pre</span><span class="o">+</span><span class="n">post</span><span class="p">)</span><span class="o">-</span><span class="p">((</span><span class="n">pre</span><span class="o">+</span><span class="n">post</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">nsamples</span><span class="p">)):(</span><span class="n">pre</span><span class="o">+</span><span class="n">post</span><span class="p">),:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">nsamples</span><span class="p">,:]</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">raw_waves</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>

<span class="c1">#            filt_waves = self.butterFilter(raw_waves,300,6000)</span>
			<span class="n">mean_filt_waves</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">raw_waves</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
			<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
			<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
			<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">mean_filt_waves</span><span class="p">[:,:])</span>
			<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Cluster &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cluster</span><span class="p">))</span>
			<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
			<span class="k">yield</span> <span class="n">cluster</span>
<div class="viewcode-block" id="SpkWaveform.plotAll"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.SpkWaveform.plotAll">[docs]</a>	<span class="k">def</span> <span class="nf">plotAll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="c1"># NOTE:</span>
		<span class="c1"># Will plot all clusters in self.clusters in a single figure window</span>
		<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span>
		<span class="n">nrows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">)))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">):</span>
			<span class="n">cluster_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spk_clusters</span> <span class="o">==</span> <span class="n">cluster</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">nspikes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_idx</span><span class="p">)</span>
			<span class="n">data_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spk_times</span><span class="p">[</span><span class="n">cluster_idx</span><span class="p">]</span>
			<span class="n">data_from_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_idx</span><span class="o">-</span><span class="n">pre</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
			<span class="n">data_to_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_idx</span><span class="o">+</span><span class="n">post</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
			<span class="n">raw_waves</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nspikes</span><span class="p">,</span> <span class="n">pre</span><span class="o">+</span><span class="n">post</span><span class="p">,</span> <span class="n">nchannels</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>

			<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">data_from_idx</span><span class="p">,</span> <span class="n">data_to_idx</span><span class="p">)):</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
					<span class="n">raw_waves</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],:]</span>
				<span class="k">elif</span> <span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">nsamples</span><span class="p">):</span>
					<span class="n">raw_waves</span><span class="p">[</span><span class="n">i</span><span class="p">,(</span><span class="n">pre</span><span class="o">+</span><span class="n">post</span><span class="p">)</span><span class="o">-</span><span class="p">((</span><span class="n">pre</span><span class="o">+</span><span class="n">post</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">nsamples</span><span class="p">)):(</span><span class="n">pre</span><span class="o">+</span><span class="n">post</span><span class="p">),:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">nsamples</span><span class="p">,:]</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">raw_waves</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>

			<span class="n">mean_filt_waves</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">raw_waves</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
			<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span><span class="n">nrows</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">mean_filt_waves</span><span class="p">[:,:])</span>
			<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="SpkWaveform.butterFilter"><a class="viewcode-back" href="../../../source/ephysiopy.openephys2py.html#ephysiopy.openephys2py.OEKiloPhy.SpkWaveform.butterFilter">[docs]</a>	<span class="k">def</span> <span class="nf">butterFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
		<span class="n">nyqlim</span> <span class="o">=</span> <span class="mf">3e4</span> <span class="o">/</span> <span class="mi">2</span>
		<span class="n">lowcut</span> <span class="o">=</span> <span class="n">low</span> <span class="o">/</span> <span class="n">nyqlim</span>
		<span class="n">highcut</span> <span class="o">=</span> <span class="n">high</span> <span class="o">/</span> <span class="n">nyqlim</span>
		<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span> <span class="k">as</span> <span class="n">signal</span>
		<span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">butter</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="p">[</span><span class="n">lowcut</span><span class="p">,</span> <span class="n">highcut</span><span class="p">],</span> <span class="n">btype</span><span class="o">=</span><span class="s1">&#39;band&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">signal</span><span class="o">.</span><span class="n">filtfilt</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">sig</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Robin Hayman

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>